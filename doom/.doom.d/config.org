#+TITLE: Doom Config
#+PROPERTY: header-args:elisp :tangle config.el :cache yes :results silent :padline no
#+EXPORT_FILE_NAME: README.md
#+STARTUP: content
#+options: toc:3

# Local Variables:
# org-confirm-babel-evaluate: nil
# eval: (add-hook 'after-save-hook (lambda ()(org-babel-tangle)) nil t)
# End:

#+begin_src elisp
;;; config.el --- -*- lexical-binding: t -*-
#+end_src

#+begin_src elisp
;; This config is autogenerated. See config.org. ;;
#+end_src

* Table of Contents :toc:
- [[#personal-information][Personal Information]]
  - [[#name-and-email][Name and email]]
  - [[#mail][Mail]]
- [[#ui][UI]]
  - [[#theme][Theme]]
  - [[#font][Font]]
- [[#editor][Editor]]
  - [[#colemac][Colemac]]
  - [[#line-numbers][Line numbers]]
  - [[#completion][Completion]]
  - [[#expand-region][Expand region]]
  - [[#line-endings][Line endings]]
- [[#mode-config][Mode config]]
  - [[#org-mode][Org-mode]]
  - [[#magit][Magit]]
  - [[#python][Python]]
  - [[#eshell][Eshell]]
- [[#bindings][Bindings]]

* Personal Information
** Name and email
Some functionality uses this to identify you, e.g. GPG configuration, email
clients, file templates and snippets.
#+BEGIN_SRC elisp
(setq user-full-name "Christoffer Arvidsson"
      user-mail-address "christoffer@arvidson.nu")
#+END_SRC

** Mail
*** Mu4e
Use mu4e as mail handler, this loads from gmail. Each path is relative to
=+mu4e-mu4e-mail-path=, which is =~/.mail= by default. Here, I set it to =~/Mail=
#+begin_src elisp :tangle (if (string= system-name "station") "yes" "no")
(use-package! mu4e
  :config
  (setq +mu4e-mu4e-mail-path "~/.mail/gmail"
        mu4e-change-filenames-when-moving t
        mu4e-index-cleanup t      ;; do a full cleanup check
        mu4e-index-lazy-check nil)       ;; consider up-to-date dirs

  (set-email-account! "arvidson.nu"
                      '((mu4e-sent-folder       . "/gmail/[Gmail]/Sent Mail")
                        (mu4e-drafts-folder     . "/gmail/[Gmail]/Drafts")
                        (mu4e-trash-folder      . "/gmail/[Gmail]/Bin")
                        (mu4e-refile-folder     . "/gmail/[Gmail]/All Mail")
                        (smtpmail-smtp-user     . "christoffer@arvidson.nu")
                        (mu4e-compose-signature . "---\nChristoffer Arvidsson"))
                      t)

  (setq mu4e-bookmarks
        '((:name "Unread messages" :query
          (concat
           "flag:unread AND NOT flag:trashed "
           "AND NOT maildir:/gmail/[Gmail]/Bin "
           "AND NOT maildir:/gmail/[Gmail]/Spam"
           ) :key 117)
         (:name "Today's messages" :query "date:today..now AND NOT maildir:/gmail/[Gmail]/Sent Mail" :key 116)
         (:name "Last 7 days" :query "date:7d..now" :hide-unread t :key 119)
         (:name "Messages with images" :query "mime:image/*" :key 112)))

  (setq mu4e-maildir-shortcuts
        '((:maildir "/gmail/[Gmail]/Sent Mail"     :key ?s)
          (:maildir "/gmail/[Gmail]/Drafts"        :key ?d)
          (:maildir "/gmail/[Gmail]/Spam"          :key ?S)
          (:maildir "/gmail/[Gmail]/All Mail"      :key ?a)))
  )
#+end_src

#+RESULTS:
: t

*** Notifications with mu4e-alert
Desktop notifications and modeline icon
#+begin_src elisp :tangle (if (string= system-name "station") "yes" "no")
(use-package! mu4e-alert
  :config
  (setq mu4e-alert-email-notification-types '(subjects))
  (setq mu4e-alert-interesting-mail-query
        (concat
         "flag:unread"
         " AND NOT flag:trashed")
  )
  ;; (mu4e-alert-set-default-style 'libnotify)
  ;; (mu4e-alert-enable-notifications)
  (mu4e-alert-enable-mode-line-display)
)
#+end_src

#+RESULTS:
: t

* UI
** Theme
There are two ways to load a theme. Both assume the theme is installed and
available. You can either set `doom-theme' or manually load a theme with the
`load-theme' function. Here we set the doom-horizon theme.

#+begin_src elisp
(use-package! doom-themes
  :config
  ;; Global settings (defaults)

  (setq doom-themes-enable-bold t      ; if nil, bold is universally disabled
        doom-themes-enable-italic t)   ; if nil, italics is universally disabled

  ;; Treemacs
  (setq doom-themes-treemacs-theme "doom-colors")
  (setq doom-theme 'doom-horizon)
  (setq doom-horizon-brighter-comments t)
  (doom-themes-treemacs-config)

  ;; Corrects (and improves) org-mode's native fontification.
  (doom-themes-org-config)

  )
#+end_src

The following changes the color of org mode blocks (src, example, quote etc.) to
be more obvious by darkening them.
#+begin_src elisp
(after! org
  (after! doom-themes
    (set-face-background 'org-block (doom-darken 'bg 0.15))
    (set-face-background 'org-block-begin-line (doom-darken 'bg 0.15))
  )
)
#+end_src

** Font
Iosevka and overpass fonts.

#+begin_src elisp
(setq doom-font (font-spec :family "iosevka" :size 14))
#+end_src

* Editor
** Colemac :unused:
Following is a configuration for colemak-dh and its wide variant.
*** Evil
#+begin_src elisp
;; (use-package! evil-colemak-basics
;;     :after evil
;;     :hook (after-init . global-evil-colemak-basics-mode)
;;     :config
;;     (setq evil-colemak-basics-rotate-t-f-j nil))
#+end_src

*** Window navigation
Fix window hopping
#+begin_src elisp
;; (after! evil
;;   (map! :leader
;;         "w m" 'evil-window-left
;;         "w n" 'evil-window-down
;;         "w e" 'evil-window-up
;;         "w i" 'evil-window-right)
  )
#+end_src

*** Ivy
Minibuffer bugged out. This fixes that.
#+begin_src elisp
;; (after! ivy
;;   (map! :map ivy-minibuffer-map
;;         "C-n" 'ivy-next-line
;;         "C-e" 'ivy-previous-line)

;;   ;; Makes it behave in the minibuffer
;;   (map! :leader
;;         "C-n" 'next-line
;;         "C-e" 'previous-line))
#+end_src

*** TODO Magit
Haven't been able to fix fetch and pull yet. Evil seems to take precedence
#+begin_src elisp
;; (after! evil-collection-magit
;;   (map! (:map magit-mode-map
;;         :nv "l" 'magit-log
;;         :nv "f" 'magit-fetch
;;         :nv "F" 'magit-pull)))

#+end_src

#+begin_src elisp
;; (evil-define-key* '(normal visual) magit-mode-map
;;   "l" #'magit-log)
#+end_src


#+RESULTS:
** Line numbers
Relative line numbers allows using relational vim bindings, ie. =10k= to move 10 lines up, for example. Enable this to get better at using them.

#+begin_src elisp
(setq display-line-numbers-type 'relative)
#+end_src

** Completion
Completion settings.
#+begin_src elisp
(require 'company)
(setq company-idle-delay 0.0
      company-minimum-prefix-length 1)
#+end_src

** Expand region
[[https://github.com/magnars/expand-region.el][Expand region]] allows pressing =<leader> v v v v v...= repeatedly to expand the
visual mode from current point. For example, if your cursor is within the curly
brackets, you can select everything within the parenthesis in =(Hello my name is
{name})= by pressing =leader v v v=.
#+begin_src elisp
(map! :leader "v" 'er/expand-region)
#+end_src

** Line endings
Convert line endings to unix
#+begin_src elisp
(defun no-junk-please-were-unixish ()
  (let ((coding-str (symbol-name buffer-file-coding-system)))
    (when (string-match "-\\(?:dos\\|mac\\)$" coding-str)
      (set-buffer-file-coding-system 'unix))))

(add-hook 'find-file-hooks 'no-junk-please-were-unixish)
#+end_src
* Mode config
** Org-mode
*** Keybindings
#+begin_src elisp
(map! :map org-mode-map
      :leader
      "t t" 'toggle-truncate-lines
      )
#+end_src

*** General org settings
If you use `org' and don't want your org files in the default location below,
change `org-directory'. It must be set before org loads!
#+BEGIN_SRC elisp
(setq org-directory "~/Dropbox/org/")
(setq org-capture-todo-file "~/Dropbox/org/agenda.org")
#+END_SRC

#+begin_src elisp
(after! org
  ;; Visual stuff
  (setq org-pretty-entities nil
        org-hide-emphasis-markers t
        org-startup-with-inline-images "inlineimages"
        org-fontify-whole-heading-line t
        org-src-fontify-natively t
        org-fontify-done-headline t
        org-fontify-quote-and-verse-blocks t
        org-startup-truncated nil) ;; Force org to not truncate lines

  (setq org-latex-prefer-user-labels t)

  )
#+end_src

*** File handling
This controls what is used to open links in org documents. Since there are only
a few defaults defined, I am just prepending them to my changes instead of
dealing with append and stuff.

#+begin_src elisp
(after! org
  (setq org-file-apps
        '((auto-mode . emacs)
          ("\\.mm\\'" . default)
          ("\\.x?html?\\'" . default)
          ("\\.pdf\\'" . "zathura %s")
          ("\\.png\\'" . viewnior)
          ("\\.jpg\\'" . viewnior)
          ("\\.svg\\'" . viewnior)
          )))
#+end_src

*** Org download
Org download allows me to screenshot regions of my screen directly into org mode
buffers. It is useful for grabbing images during lectures, etc.

Change screenshot backend of org-download (it now uses xfce4-screenshooter,
which does not have ugly borders that scrot has).
#+begin_src elisp
(after! org-download
  (setq org-download-screenshot-method "xfce4-screenshooter -r -o cat > %s")
  (setq org-download-method 'directory))
#+end_src

*** Notebooking and babel
**** Keybindings
#+begin_src elisp
(after! org
  (map! :leader "m k s" 'org-babel-demarcate-block)
  )
#+end_src

**** Jupyter emacs
Bread and butter for using python in org-mode for notebook style execution.

Make a template for inserting jupyter blocks.
#+begin_src elisp
(after! org
  (setq org-babel-python-command "~/.pyenv/shims/python")
  (add-to-list 'org-structure-template-alist
               '("j" . "src jupyter-python"))

  (setq org-babel-default-header-args:jupyter-python '((:async . "yes")
                                                       (:kernel . "python3")
                                                       (:exports . "code")
                                                       (:session . "py")
                                                       (:eval . "never-export")))
  )
#+end_src

**** Org auto tangle
Automatically tangle src blocks on save. Makes working with literate programming very nice since code is always up to date in tangled files.
#+begin_src elisp
(use-package! org-auto-tangle
  :defer t
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq org-auto-tangle-default nil))
#+end_src

*** Productivity
**** Agenda
***** General settings
#+begin_src elisp
(after! org
  (setq! org-agenda-files (list "~/Dropbox/org/agenda.org")
         +org-capture-todo-file "agenda.org"))
#+end_src

***** Super agenda
#+begin_src elisp
(use-package! org-super-agenda
  :commands (org-super-agenda-mode))

(after! org-agenda
  (org-super-agenda-mode))

(setq org-agenda-skip-scheduled-if-done t
      org-agenda-skip-deadline-if-done t
      org-agenda-include-deadlines t
      org-agenda-block-separator nil
      org-agenda-tags-column 100 ;; from testing this seems to be a good value
      org-agenda-compact-blocks t)

(setq org-agenda-custom-commands
      '(("o" "Overview"
         ((agenda "" ((org-agenda-span 'day)
                      (org-super-agenda-groups
                       '((:name "Today"
                          :time-grid t
                          :date today
                          :todo "TODAY"
                          :scheduled today
                          :order 1)))))
          (alltodo "" ((org-agenda-overriding-header "")
                       (org-super-agenda-groups
                        '((:name "Next to do"
                           :todo "NEXT"
                           :order 1)
                          (:name "Important"
                           :tag "important"
                           :priority "A"
                           :order 6)
                          (:name "Due Today"
                           :deadline today
                           :order 2)
                          (:name "Due Soon"
                           :deadline future
                           :order 8)
                          (:name "Overdue"
                           :deadline past
                           :face error
                           :order 7)
                          (:name "Assignments"
                           :tag "assignment"
                           :order 10)
                          (:name "Issues"
                           :tag "issue"
                           :order 12)
                          (:name "Emacs"
                           :tag "emacs"
                           :order 13)
                          (:name "Projects"
                           :tag "project"
                           :order 14)
                          (:name "Research"
                           :tag "research"
                           :order 15)
                          (:name "To read"
                           :tag "read"
                           :order 30)
                          (:name "Waiting"
                           :todo "WAITING"
                           :order 20)
                          (:name "University"
                           :tag "uni"
                           :order 32)
                          (:name "Trivial"
                           :priority<= "E"
                           :tag ("trivial" "unimportant")
                           :todo ("SOMEDAY" )
                           :order 90)
                          (:discard (:tag ("chore" "routine" "daily")))))))))))
#+end_src
***** Capture templates
Capture templates to easier file different tasks into the agenda file
#+begin_src elisp
(after! org
  (setq org-capture-templates
        '(("t" "Personal todo" entry
           (file+headline +org-capture-todo-file "Inbox")
           "* [ ] %?\n%i\n%a" :prepend t)
          ("n" "Personal notes" entry
           (file+headline +org-capture-notes-file "Inbox")
           "* %u %?\n%i\n%a" :prepend t)
          ("r" "Research" entry
           (file+headline +org-capture-todo-file "Research")
           "* %u %?\n%i\n%a" :prepend t)
          ("u" "University" entry
           (file+headline +org-capture-todo-file "University")
           "* [ ] %u %?\n%i\n%a" :prepend t)

          ("p" "Templates for projects")
          ("pt" "Project todo" entry
           #'+org-capture-central-project-todo-file "* [ ] %?\n %i\n %a" :heading "Tasks" :prepend nil)
          ("pn" "Project notes" entry
           #'+org-capture-central-project-notes-file "* %U %?\n %i\n %a" :heading "Notes" :prepend t)
          ("pc" "Project changelog" entry
           #'+org-capture-central-project-changelog-file "* %U %?\n %i\n %a" :heading "Changelog" :prepend t))))
#+end_src

***** TODO Setup alerts
**** Elfeed
Read your rss in emacs!
#+begin_src elisp
(map! :leader "o f" 'elfeed)

(after! elfeed-org
  (elfeed-org)
  (add-hook! 'elfeed-search-mode-hook 'elfeed-update)
  (setq rmh-elfeed-org-files (list "~/Dropbox/org/elfeed/elfeed.org"))

  (use-package! elfeed-link)

  (setq elfeed-search-filter "@1-week-ago"
        elfeed-search-print-entry-function '+rss/elfeed-search-print-entry
        elfeed-search-title-min-width 80
        elfeed-show-entry-switch #'pop-to-buffer
        elfeed-show-entry-delete #'+rss/delete-pane
        elfeed-show-refresh-function #'+rss/elfeed-show-refresh--better-style
        shr-max-image-proportion 0.6)

  (add-hook! 'elfeed-show-mode-hook (hide-mode-line-mode 1))
  (add-hook! 'elfeed-search-update-hook #'hide-mode-line-mode)

  (defface elfeed-show-title-face '((t (:weight ultrabold :slant italic :height 1.5)))
    "title face in elfeed show buffer"
    :group 'elfeed)
  (defface elfeed-show-author-face `((t (:weight light)))
    "title face in elfeed show buffer"
    :group 'elfeed)
  (set-face-attribute 'elfeed-search-title-face nil
                      :foreground 'nil
                      :weight 'light)

  (defadvice! +rss-elfeed-wrap-h-nicer ()
    "Enhances an elfeed entry's readability by wrapping it to a width of
`fill-column' and centering it with `visual-fill-column-mode'."
    :override #'+rss-elfeed-wrap-h
    (let ((inhibit-read-only t)
          (inhibit-modification-hooks t))
      (setq-local truncate-lines nil)
      (setq-local shr-width 120)
      (setq-local line-spacing 0.2)
      (setq-local visual-fill-column-center-text t)
      (visual-fill-column-mode)
      ;; (setq-local shr-current-font '(:family "Merriweather" :height 1.2))
      (set-buffer-modified-p nil)))

  (defun +rss/elfeed-search-print-entry (entry)
    "Print ENTRY to the buffer."
    (let* ((elfeed-goodies/tag-column-width 40)
           (elfeed-goodies/feed-source-column-width 30)
           (title (or (elfeed-meta entry :title) (elfeed-entry-title entry) ""))
           (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
           (feed (elfeed-entry-feed entry))
           (feed-title
            (when feed
              (or (elfeed-meta feed :title) (elfeed-feed-title feed))))
           (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
           (tags-str (concat (mapconcat 'identity tags ",")))
           (title-width (- (window-width) elfeed-goodies/feed-source-column-width
                           elfeed-goodies/tag-column-width 4))

           (tag-column (elfeed-format-column
                        tags-str (elfeed-clamp (length tags-str)
                                               elfeed-goodies/tag-column-width
                                               elfeed-goodies/tag-column-width)
                        :left))
           (feed-column (elfeed-format-column
                         feed-title (elfeed-clamp elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width)
                         :left)))

      (insert (propertize feed-column 'face 'elfeed-search-feed-face) " ")
      (insert (propertize tag-column 'face 'elfeed-search-tag-face) " ")
      (insert (propertize title 'face title-faces 'kbd-help title))
      (setq-local line-spacing 0.2)))

  (defun +rss/elfeed-show-refresh--better-style ()
    "Update the buffer to match the selected entry, using a mail-style."
    (interactive)
    (let* ((inhibit-read-only t)
           (title (elfeed-entry-title elfeed-show-entry))
           (date (seconds-to-time (elfeed-entry-date elfeed-show-entry)))
           (author (elfeed-meta elfeed-show-entry :author))
           (link (elfeed-entry-link elfeed-show-entry))
           (tags (elfeed-entry-tags elfeed-show-entry))
           (tagsstr (mapconcat #'symbol-name tags ", "))
           (nicedate (format-time-string "%a, %e %b %Y %T %Z" date))
           (content (elfeed-deref (elfeed-entry-content elfeed-show-entry)))
           (type (elfeed-entry-content-type elfeed-show-entry))
           (feed (elfeed-entry-feed elfeed-show-entry))
           (feed-title (elfeed-feed-title feed))
           (base (and feed (elfeed-compute-base (elfeed-feed-url feed)))))
      (erase-buffer)
      (insert "\n")
      (insert (format "%s\n\n" (propertize title 'face 'elfeed-show-title-face)))
      (insert (format "%s\t" (propertize feed-title 'face 'elfeed-search-feed-face)))
      (when (and author elfeed-show-entry-author)
        (insert (format "%s\n" (propertize author 'face 'elfeed-show-author-face))))
      (insert (format "%s\n\n" (propertize nicedate 'face 'elfeed-log-date-face)))
      (when tags
        (insert (format "%s\n"
                        (propertize tagsstr 'face 'elfeed-search-tag-face))))
      ;; (insert (propertize "Link: " 'face 'message-header-name))
      ;; (elfeed-insert-link link link)
      ;; (insert "\n")
      (cl-loop for enclosure in (elfeed-entry-enclosures elfeed-show-entry)
               do (insert (propertize "Enclosure: " 'face 'message-header-name))
               do (elfeed-insert-link (car enclosure))
               do (insert "\n"))
      (insert "\n")
      (if content
          (if (eq type 'html)
              (elfeed-insert-html content base)
            (insert content))
        (insert (propertize "(empty)\n" 'face 'italic)))
      (goto-char (point-min))))
  )
#+end_src

*** Writing
**** Spell optimization
Speedup spell in org mode
#+begin_src elisp
(after! spell
  (remove-hook 'mu4e-compose-mode-hook #'org-mu4e-compose-org-mode()
               (setq enable-flyspell-auto-completion t)
               ))
#+end_src
**** Org roam
I transferred to org-roam after I realized I hated hierarchical documents. Ideas
apply to many different subjects, which org-roam handles very well. This block
setups org-roam and enables it.
#+begin_src elisp
(use-package! org-roam
  :defer t
  :config
  (setq org-roam-directory "~/Dropbox/org/org-roam")
  (setq org-roam-db-location "~/Dropbox/org/org-roam/org-roam.db")
  (set-company-backend! 'org-mode '(company-org-roam company-yasnippet company-dabbrev)))
#+end_src

Setup capture templates for org-roam. I made these load from template files for faster editing.
#+begin_src elisp
(after! org-roam
  (setq org-roam-capture-templates
        '(("l" "latex")
          ("ld" "temporary note" plain (function org-roam-capture--get-point)
           (file "/home/eethern/.doom.d/templates/draft.org")
           :file-name "draft/%<%Y%m%d%H%M%S>-${slug}"
           :unnarrowed t)
          ("ll" "lecture note" plain (function org-roam-capture--get-point)
           (file "/home/eethern/.doom.d/templates/lecture_note.org")
           :file-name "lecture/%<%Y%m%d%H%M%S>-${slug}"
           :unnarrowed t)
          ("lp" "permanent note" plain (function org-roam-capture--get-point)
           (file "/home/eethern/.doom.d/templates/latex.org")
           :file-name "%<%Y%m%d%H%M%S>-${slug}"
           :unnarrowed t)
          ("la" "assignment" plain (function org-roam-capture--get-point)
           (file "/home/eethern/.doom.d/templates/latex.org")
           :file-name "assignment/%<%Y%m%d%H%M%S>-${slug}"
           :unnarrowed t)
          ("le" "exercise" plain (function org-roam-capture--get-point)
           (file "/home/eethern/.doom.d/templates/exercise.org")
           :file-name "exercise/%<%y%m%d%h%m%s>-${slug}"
           :unnarrowed t)
          ("p" "project" plain (function org-roam-capture--get-point)
           (file "/home/eethern/.doom.d/templates/project.org")
           :file-name "project/${slug}/README"
           :unnarrowd t)
           )
          )
        )
#+end_src

And for dailies
#+begin_src elisp
(after! org-roam
  (setq org-roam-dailies-capture-templates
        '(("d" "default" entry
           #'org-roam-capture--get-point
           "* %?"
           :file-name "daily/%<%Y-%m-%d>"
           :head "#+title: %<%Y-%m-%d>\n\n#+ROAM_TAGS: Dailies\n"
           ))))
#+end_src

Setup org roam server. This does some nice styling and physics simulations to
make the graph view much nicer.

#+begin_src elisp
(after! org-roam-server
  (require 'json)
  (setq org-roam-server-network-vis-options
        (json-encode (list
                      (cons 'physics
                            (list
                             (cons 'enabled t)
                             (cons 'stabilization
                                   (list
                                    (cons 'enabled t)
                                    (cons 'iterations 10)
                                    (cons 'fit t)))
                             (cons 'timestep 1.0)
                             (cons 'maxVelocity 20)
                             (cons 'solver "barnesHut")
                             ;; (cons 'repulsion
                             ;;       (list
                             ;;        (cons 'nodeDistance 400)
                             ;;        (cons 'centralGravity 0.5)
                             ;;        (cons 'springLength 100)
                             ;;        (cons 'springConstant 0.05)
                             ;;        (cons 'damping 0.5)))))
                             (cons 'barnesHut
                                   (list
                                    (cons 'theta 0.5)
                                    (cons 'graviationalConstant -500000)
                                    (cons 'centralGravity 0.1)
                                    (cons 'springLength 1000)
                                    (cons 'springConstant 0.01)
                                    (cons 'damping 0.1)
                                    (cons 'avoidOverlap 0)))))
                      (cons 'edges
                            (list
                             (cons 'physics t)
                             (cons 'length 20)
                             (cons 'width 0.15)
                             (cons 'hidden json-false)
                             (cons 'smooth
                                   (list
                                    (cons 'enabled t)
                                    (cons 'type "continuous")))
                             (cons 'color
                                   (list
                                    (cons 'border "#ffffff")
                                    (cons 'background "#ffffff")
                                    (cons 'highlight "#6f5ecc")
                                    (cons 'hover "#6f5ecc")))))
                      (cons 'nodes
                            (list
                             (cons 'mass 2)
                             (cons 'font
                                   (list
                                    (cons 'size 16)))
                             (cons 'color
                                   (list
                                    (cons 'border "#222222")
                                    (cons 'background "#bbbbbb")
                                    (cons 'highlight "#6f5ecc")
                                    (cons 'hover "#6f5ecc")))))
                      (cons 'options
                            (list
                             (cons 'highlight-nearest
                                   (list
                                    (cons 'enabled t)
                                    (cons 'degree 2))))))))
  )
#+end_src

***** Bibliography
Setup org-roam-bibtex
#+begin_src elisp
(use-package! org-roam-bibtex
  :after org-roam
  :hook (org-roam-mode . org-roam-bibtex-mode)
  :config
  (require 'org-ref)) ; optional: if Org Ref is not loaded anywhere else, load it here
#+end_src

**** Org ref
Manage references using org-ref.
#+begin_src elisp
(after! org
  (setq reftex-default-bibliography "/home/eethern/Dropbox/bibliography/references.bib")
  (setq org-ref-bibliography-notes "~/Dropbox/bibliography/notes.org"
        org-ref-default-bibliography (list "/home/eethern/Dropbox/bibliography/references.bib")
        org-ref-pdf-directory "~/Dropbox/bibliography/bibtex-pdfs/")

  (setq org-ref-completion-library 'org-ref-ivy-cite)
  (map! :map org-mode-map :localleader
        :desc "Insert org-ref reference link"
        "l r" 'org-ref-insert-ref-link)

                                        ; Makes org-ref reload its completion on save rather than just on buffer reload
  (add-hook 'after-save-hook (lambda ()
                               (setq org-ref-labels nil))))
#+end_src

**** Org fragtog - Automate latex inline rendering
An annoying thing about latex equations in org mode is that you have to toggle
them to display and undisplay images. org-fragtog only shows the latex code if
you hover over. Also make the equations bigger scale with text scaling

#+begin_src elisp
(after! org
  (add-hook! org-mode org-fragtog-mode)

                                        ; Scale depending on zoom level
  (defun update-org-latex-fragment-scale ()
    (let ((text-scale-factor (expt text-scale-mode-step text-scale-mode-amount)))
      (plist-put org-format-latex-options :scale (* 1.5 text-scale-factor)))
    )
  (add-hook 'text-scale-mode-hook 'update-org-latex-fragment-scale)
  )
#+end_src

**** Org appear
Use org-appear to reveal emphasis markers when moving the cursor over them.
#+begin_src elisp
(after! org
  (add-hook! org-mode :append #'org-appear-mode)
  )
#+end_src

**** Latex export
Export minted latex source code in pdf, using latexmk.

#+begin_src elisp
(after! org
  (add-to-list 'org-latex-packages-alist '("" "minted"))
  (setq org-latex-listings 'minted)
  (setq org-latex-pdf-process (list "latexmk -shell-escape -bibtex -f -pdf %f"))
  (setq org-src-fontify-natively t)
  )

#+end_src

Although I want to not evalaute src blocks on export, settings the following
option to nil makes org disregard header arguments such as =:exports=, which for
me makes this completely unusable. Instead, I use =:eval never-export= in large
runtime org files.
#+begin_src elisp
(after! org
  (setq org-export-use-babel t)
  )
#+end_src

**** Inline image size
Make large images not take up entire buffer
#+begin_src elisp
(after! org
  (setq org-image-actual-width nil))
#+end_src
**** Cdlatex
Makes math more bearable in org-mode, therefore activate it.
#+begin_src elisp
(after! org
  (add-hook 'org-mode-hook #'org-cdlatex-mode))
#+end_src
**** PDF-tools
#+begin_src elisp
(after! pdf-tools
  (add-hook 'pdf-view-mode-hook 'auto-revert-mode))
#+end_src
** Magit
Bring back the sidebuffer for magit.
#+begin_src elisp
(set-popup-rule! "\\^*magit" :side 'right :width 0.4)
#+end_src

** Python
Configure python
#+begin_src elisp
(setq python-shell-interpreter "~/.pyenv/shims/python")
(map! :map python-mode-map
      :localleader
      "c" 'python-shell-send-buffer
      "r" 'run-python)
#+end_src

** Eshell
#+begin_src elisp
(after! eshell
  (setq eshell-term-name "kitty")
)
#+end_src
* Bindings
Collection of nice bindings I use throughout the emacs journey.
#+BEGIN_SRC elisp
(map! :leader
      "TAB" 'evil-switch-to-windows-last-buffer ; Switch to last buffer
      "f w" 'find-file-other-window
      "o c" 'quick-calc
      "o C" 'calc
      "i p" 'academic-phrases
      "i P" 'academic-phrases-by-section)
#+END_SRC
